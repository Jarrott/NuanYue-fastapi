<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Binance 实时行情 & 订单事件中心</title>
  <style>
    body { background: #0e1726; color: #e0e0e0; font-family: monospace; padding: 20px; }
    h2 { color: #ffcc00; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #333; padding: 8px 10px; text-align: left; }
    th { background: #1e293b; }
    tr:nth-child(even) { background: #1b2433; }
    .log { margin-top: 15px; background: #1a2233; padding: 10px; border-radius: 6px; font-size: 14px; }
    .highlight { color: #00ff99; }
    .error { color: #ff5555; }
  </style>
</head>
<body>

  <h2>📊 Binance 全币种实时行情 & 🧾 用户订单通知</h2>
  <div id="status">连接中...</div>

  <table id="market">
    <thead>
      <tr><th>交易对</th><th>最新价</th><th>成交量</th><th>时间</th></tr>
    </thead>
    <tbody id="market-body"></tbody>
  </table>

  <div class="log">
    <h3>🧾 订单事件</h3>
    <div id="order-log"></div>
  </div>

  <div class="log">
    <h3>📢 系统广播</h3>
    <div id="system-log"></div>
  </div>

<script>
(async () => {
  // 模拟当前登录用户
  const uid = 1;
  const ws = new WebSocket(`ws://localhost:5001/v1/ws/market?uid=${uid}`);
  const marketBody = document.getElementById("market-body");
  const orderLog = document.getElementById("order-log");
  const sysLog = document.getElementById("system-log");
  const statusDiv = document.getElementById("status");

  const formatTime = (ts) => new Date(ts).toLocaleTimeString();

  ws.onopen = () => {
    statusDiv.innerHTML = `✅ 已连接 (${uid})`;
    ws.send(JSON.stringify({ action: "subscribe", channel: "all" })); // 订阅全局行情
    ws.send(JSON.stringify({ action: "subscribe", channel: `user_id:${uid}` })); // 订阅个人订单事件
  };

  ws.onclose = () => {
    statusDiv.innerHTML = "❌ 已断开连接";
  };

  ws.onerror = (err) => {
    console.error("WebSocket错误:", err);
    statusDiv.innerHTML = "⚠️ WebSocket 出错";
  };

  ws.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      handleMessage(msg);
    } catch (err) {
      console.error("消息解析失败:", event.data);
    }
  };

  function handleMessage(msg) {
    // 心跳
    if (msg.type === "ping") return;

    // 行情广播
    if (msg.type === "ticker" || msg.event === "kline") {
      const { symbol, close, volume, interval } = msg;
      updateMarket(symbol, close, volume, interval);
    }

    // 用户订单完成事件
    else if (msg.type === "order" && msg.event === "'order.completed") {
      const text = `📦 订单 ${msg.order_id} 已完成 ✅`;
      append(orderLog, text, "highlight");
    }

    // 系统广播
    else if (msg.type === "system" && msg.event === "announcement") {
      const text = `📢 ${msg.message}`;
      append(sysLog, text);
    }

    // 其他事件
    else {
      append(sysLog, `未知消息: ${JSON.stringify(msg)}`, "error");
    }
  }

  function updateMarket(symbol, close, volume, interval) {
    let row = document.getElementById(symbol);
    if (!row) {
      row = document.createElement("tr");
      row.id = symbol;
      row.innerHTML = `<td>${symbol}</td><td></td><td></td><td></td>`;
      marketBody.appendChild(row);
    }
    row.cells[1].textContent = close;
    row.cells[2].textContent = volume;
    row.cells[3].textContent = formatTime(Date.now());
  }

  function append(container, text, cls) {
    const div = document.createElement("div");
    if (cls) div.classList.add(cls);
    div.textContent = `[${formatTime(Date.now())}] ${text}`;
    container.prepend(div);
  }

})();
</script>

</body>
</html>
