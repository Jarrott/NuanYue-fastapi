<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>Binance å®æ—¶è¡Œæƒ… & è®¢å•äº‹ä»¶ä¸­å¿ƒ</title>
  <style>
    body { background: #0e1726; color: #e0e0e0; font-family: monospace; padding: 20px; }
    h2 { color: #ffcc00; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #333; padding: 8px 10px; text-align: left; }
    th { background: #1e293b; }
    tr:nth-child(even) { background: #1b2433; }
    .log { margin-top: 15px; background: #1a2233; padding: 10px; border-radius: 6px; font-size: 14px; }
    .highlight { color: #00ff99; }
    .error { color: #ff5555; }
  </style>
</head>
<body>

  <h2>ğŸ“Š Binance å…¨å¸ç§å®æ—¶è¡Œæƒ… & ğŸ§¾ ç”¨æˆ·è®¢å•é€šçŸ¥</h2>
  <div id="status">è¿æ¥ä¸­...</div>

  <table id="market">
    <thead>
      <tr><th>äº¤æ˜“å¯¹</th><th>æœ€æ–°ä»·</th><th>æˆäº¤é‡</th><th>æ—¶é—´</th></tr>
    </thead>
    <tbody id="market-body"></tbody>
  </table>

  <div class="log">
    <h3>ğŸ§¾ è®¢å•äº‹ä»¶</h3>
    <div id="order-log"></div>
  </div>

  <div class="log">
    <h3>ğŸ“¢ ç³»ç»Ÿå¹¿æ’­</h3>
    <div id="system-log"></div>
  </div>

<script>
(async () => {
  // æ¨¡æ‹Ÿå½“å‰ç™»å½•ç”¨æˆ·
  const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjEsInZlciI6Miwic2NvcGUiOlsidXNlciJdLCJpYXQiOjE3NjIwODU2NDQsImV4cCI6MTc2MjA4OTI0NCwidHlwZSI6ImFjY2VzcyJ9.p4f3mGbXzKKvrDOzRIcAZTYKocHq8RK18TW2IHLtib0";
  const ws = new WebSocket(`ws://localhost:5001/v1/ws/?token=${token}`);
  const marketBody = document.getElementById("market-body");
  const orderLog = document.getElementById("order-log");
  const sysLog = document.getElementById("system-log");
  const statusDiv = document.getElementById("status");

  const formatTime = (ts) => new Date(ts).toLocaleTimeString();

  ws.onopen = () => {
    statusDiv.innerHTML = `âœ… å·²è¿æ¥ (${uid})`;
    ws.send(JSON.stringify({ action: "subscribe", channel: "all" })); // è®¢é˜…å…¨å±€è¡Œæƒ…
    ws.send(JSON.stringify({ action: "subscribe", channel: `user_id:${uid}` })); // è®¢é˜…ä¸ªäººè®¢å•äº‹ä»¶
  };

  ws.onclose = () => {
    statusDiv.innerHTML = "âŒ å·²æ–­å¼€è¿æ¥";
  };

  ws.onerror = (err) => {
    console.error("WebSocketé”™è¯¯:", err);
    statusDiv.innerHTML = "âš ï¸ WebSocket å‡ºé”™";
  };

  ws.onmessage = (event) => {
    try {
      const msg = JSON.parse(event.data);
      handleMessage(msg);
    } catch (err) {
      console.error("æ¶ˆæ¯è§£æå¤±è´¥:", event.data);
    }
  };

  function handleMessage(msg) {
    // å¿ƒè·³
    if (msg.type === "ping") return;

    // è¡Œæƒ…å¹¿æ’­
    if (msg.type === "ticker" || msg.event === "kline") {
      const { symbol, close, volume, interval } = msg;
      updateMarket(symbol, close, volume, interval);
    }

    // ç”¨æˆ·è®¢å•å®Œæˆäº‹ä»¶
    else if (msg.type === "order" && msg.event === "'order.completed") {
      const text = `ğŸ“¦ è®¢å• ${msg.order_id} å·²å®Œæˆ âœ…`;
      append(orderLog, text, "highlight");
    }

    // ç³»ç»Ÿå¹¿æ’­
    else if (msg.type === "system" && msg.event === "announcement") {
      const text = `ğŸ“¢ ${msg.message}`;
      append(sysLog, text);
    }

    // å…¶ä»–äº‹ä»¶
    else {
      append(sysLog, `æœªçŸ¥æ¶ˆæ¯: ${JSON.stringify(msg)}`, "error");
    }
  }

  function updateMarket(symbol, close, volume, interval) {
    let row = document.getElementById(symbol);
    if (!row) {
      row = document.createElement("tr");
      row.id = symbol;
      row.innerHTML = `<td>${symbol}</td><td></td><td></td><td></td>`;
      marketBody.appendChild(row);
    }
    row.cells[1].textContent = close;
    row.cells[2].textContent = volume;
    row.cells[3].textContent = formatTime(Date.now());
  }

  function append(container, text, cls) {
    const div = document.createElement("div");
    if (cls) div.classList.add(cls);
    div.textContent = `[${formatTime(Date.now())}] ${text}`;
    container.prepend(div);
  }

})();
</script>

</body>
</html>
