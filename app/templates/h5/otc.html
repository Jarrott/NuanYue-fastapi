<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>OTCå……å€¼æµ‹è¯• + é’±åŒ…å®æ—¶æ›´æ–°</title>
<style>
body { font-family: Arial; padding:20px; }
input,button,select { padding:6px; margin:5px 0; }
</style>
</head>

<body>
<h2>ğŸ”¥ OTCå……å€¼ + å®æ—¶ä½™é¢ç›‘å¬ Demo</h2>

<!-- âœ… ç™»å½• -->
<div>
  è´¦å·: <input id="username" value="test1">
  å¯†ç : <input id="password" type="password" value="123123">
  <button onclick="login()">ç™»å½•</button>
</div>
<hr>

<!-- âœ… ç”¨æˆ·é’±åŒ…ä½™é¢å®æ—¶æ˜¾ç¤º -->
<div>
  <strong>ä½™é¢ï¼š</strong><span id="balance">loading...</span> USDT
</div>
<hr>

<!-- âœ… OTC å……å€¼è¡¨å• -->
<h3>å……å€¼æäº¤</h3>
<div>
  é‡‘é¢ <input id="amount" type="number" /> <br>
  å‡­è¯å›¾ç‰‡URL <input id="proof" style="width:300px;" /> <br>
  å¸ç§ <select id="token">
    <option value="USDT">USDT</option>
  </select> <br><br>
  <button onclick="submitDeposit()">æäº¤å……å€¼</button>
</div>

<!-- âœ… Firebase + ä¸šåŠ¡è„šæœ¬ -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js";

// âœ… Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDFdByzZ3hR-pkh6TR1nCJ04tVko41Z_E8",
  authDomain: "ttte-a5dae.firebaseapp.com",
  projectId: "ttte-a5dae",
  storageBucket: "ttte-a5dae.appspot.com",
  messagingSenderId: "379230954149",
  databaseURL: "https://ttte-a5dae-default-rtdb.asia-southeast1.firebasedatabase.app",
  appId: "1:379230954149:web:19a9f93f1b881d170ba34c"
};

const API = "http://localhost:5001/v1"; // âœ… æ”¹æˆä½ çš„ FastAPI åœ°å€

let accessToken = "";
let firebaseToken = "";
let userId = "";

// åˆå§‹åŒ– Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);


// âœ… ç™»å½• FastAPI
window.login = async () => {
  const body = {
    username: document.getElementById("username").value,
    password: document.getElementById("password").value
  };

  const res = await fetch(`${API}/user/login`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });

  const data = await res.json();
  accessToken = data.access_token;
  firebaseToken = data.firebase_token;

  console.log("âœ… FastAPIç™»å½•æˆåŠŸ:", data);

  // âœ… è§£æç”¨æˆ·ä¿¡æ¯
  const res2 = await fetch(`${API}/user/information`, {
    headers:{ Authorization:`Bearer ${accessToken}` }
  });
  const u = await res2.json();
  console.log(u);
  userId = u.data.id;

  console.log("âœ… UID:", userId);

  // âœ… ç”¨ Firebase Token ç™»å½• Firebase
  await signInWithCustomToken(auth, firebaseToken);
  console.log("âœ… Firebase ç™»å½•æˆåŠŸ:", auth.currentUser.uid);

  startWalletListener();
  alert("ç™»å½•æˆåŠŸ âœ…");
};


// âœ… ç›‘å¬ç”¨æˆ·é’±åŒ…ä½™é¢
function startWalletListener() {
  const walletRef = ref(db, `user_wallet/${userId}/balance`);
  onValue(walletRef, (snap) => {
    const balance = snap.val() ?? 0;
    document.getElementById("balance").innerText = balance;
    console.log("ğŸ’°ä½™é¢æ›´æ–°:", balance);
  });
}


// âœ… OTC å……å€¼æäº¤
window.submitDeposit = async () => {
  const body = {
    amount: parseFloat(document.getElementById("amount").value),
    proof_image: document.getElementById("proof").value,
    token: document.getElementById("token").value
  };

  const res = await fetch(`${API}/user/deposit/otc`, {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:`Bearer ${accessToken}`
    },
    body:JSON.stringify(body)
  });

  const data = await res.json();
  console.log("ğŸ“¥ æäº¤ç»“æœ:", data);
  alert("å……å€¼æäº¤æˆåŠŸ âœ… ç­‰å¾…ç³»ç»Ÿå®¡æ ¸");
};
</script>
</body>
</html>
