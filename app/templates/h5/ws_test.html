<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <title>WS ç»ˆç«¯è°ƒè¯•å°</title>
    <style>
        body {
            background: #0b0e11;
            color: #d7e0ff;
            font-family: sans-serif;
            padding: 20px;
        }

        input, textarea, select, button {
            background: #13161c;
            color: #d7e0ff;
            border: 1px solid #2a2f3a;
            padding: 6px;
            border-radius: 4px;
        }

        button:hover {
            background: #2b3344;
        }

        .section-title {
            margin-top: 18px;
            font-weight: bold;
            font-size: 15px;
        }

        .log-box {
            background: #13161c;
            border: 1px solid #2a2f3a;
            padding: 8px;
            height: 150px;
            overflow-y: auto;
            border-radius: 6px;
            font-size: 13px;
            white-space: pre-wrap;
        }

        .row {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>

<h2>ğŸ”¥ WebSocket è°ƒè¯•ç»ˆç«¯</h2>

<div class="row">
    Token:
    <input id="token" style="width:380px;" placeholder="ç²˜è´´ JWT Token">
</div>

<div class="row">
    åœ°å€:
    <input id="url" style="width:350px;" value="wss://api-test.qi-yue.vip/v1/ws/user">
    <button onclick="connectWS()">è¿æ¥</button>
    <button onclick="closeWS()">æ–­å¼€</button>
</div>

<div class="row">
    è®¢é˜…:
    <select id="sub">
        <option value="">é€‰æ‹©é¢‘é“</option>
        <option value="btc-usdt-1m">BTC-USDT</option>
        <option value="eth-usdt-1m">ETH-USDT</option>
    </select>
    <button onclick="sub()">è®¢é˜…</button>
    <button onclick="unsub()">å–æ¶ˆ</button>
</div>

<div class="row">
    å‘é€:
    <textarea id="sendBox" style="width:600px;height:60px;">{"hello":"test"}</textarea>
    <button onclick="send()">å‘é€</button>
</div>

<div>â± RTT: <span id="rtt">--</span> ms</div>

<div class="section-title">ğŸ“¢ ç³»ç»Ÿå¹¿æ’­</div>
<div id="sysLog" class="log-box"></div>

<div class="section-title">ğŸ“¬ ç§äººé€šçŸ¥</div>
<div id="userLog" class="log-box"></div>

<div class="section-title">ğŸ“Š è¡Œæƒ… Debugï¼ˆç®€ï¼‰</div>
<div id="tickerLog" class="log-box"></div>

<script>
    let ws = null;
    let retry = 0;
    let hb = null;    // å¿ƒè·³è®¡æ—¶å™¨
    let lastPing = null;

    function log(id, msg) {
        const box = document.getElementById(id);
        const t = new Date().toLocaleTimeString();
        box.innerText = `[${t}] ${msg}\n` + box.innerText;
    }

    function connectWS() {
        const token = document.getElementById("token").value;
        let url = document.getElementById("url").value.trim();
        if (token) url += "?token=" + token;

        ws = new WebSocket(url);

        ws.onopen = () => {
            retry = 0;
            log("sysLog", "âœ… WebSocket è¿æ¥æˆåŠŸ");

            // âœ… è‡ªåŠ¨è®¢é˜…ç”¨æˆ·ç§æœ‰é¢‘é“
            try {
                const uid = JSON.parse(atob(token.split('.')[1])).uid;
                ws.send(JSON.stringify({action: "subscribe", channel: `user:${uid}`}));
                log("userLog", `âœ… è‡ªåŠ¨è®¢é˜… user:${uid}`);
            } catch {
            }

            // âœ… å¿ƒè·³
            hb = setInterval(() => {
                lastPing = performance.now();
                ws.send(JSON.stringify({type: "ping"}));
            }, 15000);
        };

        ws.onmessage = (e) => {
            try {
                const data = JSON.parse(e.data);

                // âœ… RTT è®¡ç®—
                if (data.type === "pong") {
                    document.getElementById("rtt").innerText = (performance.now() - lastPing).toFixed(1);
                    return;
                }

                // âœ… ç³»ç»Ÿå¹¿æ’­
                if (data.broadcast) {
                    log("sysLog", JSON.stringify(data));
                    return;
                }

                // âœ… ç§äººé€šçŸ¥
                if (data.type === "user") {
                    log("userLog", JSON.stringify(data));
                    return;
                }

                // === ğŸ”¥ Token ç»­æœŸæé†’ ===
                if (msg.type === "token" && msg.event === "refresh_required") {
                    log("sysLog", "ğŸ”„ Token å³å°†è¿‡æœŸï¼Œæ­£åœ¨åˆ·æ–°...");

                    try {
                        const refreshToken = localStorage.getItem("refresh_token");
                        if (!refreshToken) {
                            throw new Error("Missing refresh token");
                        }

                        // ğŸ” è¯·æ±‚æ–° Tokenï¼ˆç¡®ä¿ awaitï¼‰
                        const res = fetch("https://api-test.qi-yue.vip/v1/user/refresh", {
                            method: "POST",
                            headers: {
                                "Authorization": `Bearer ${refreshToken}`,
                                "Content-Type": "application/json"
                            }
                        });

                        const result = res.json();
                        if (!result?.access_token) {
                            throw new Error("Token refresh failed");
                        }

                        // ğŸ§  ä¿å­˜æ–° Token
                        localStorage.setItem("token", result.access_token);

                        // ğŸ“© å‘é€æ–° Token å‘Šè¯‰æœåŠ¡å™¨æ›´æ–°ä¼šè¯
                        ws.send(JSON.stringify({
                            type: "refresh",
                            token: result.access_token
                        }));

                        log("sysLog", "âœ… Token å·²æ›´æ–°ï¼Œæ— éœ€æ–­çº¿é‡è¿");
                    } catch (err) {
                        log("sysLog", "âŒ Token ç»­æœŸå¤±è´¥ï¼šéœ€è¦é‡æ–°ç™»å½•");
                        closeWS();
                    }

                    return;
                }

            } catch (err) {
                log("sysLog", "âš  JSON è§£æå¤±è´¥ " + e.data);
            }
        };

        ws.onerror = () => log("sysLog", "âŒ WS é”™è¯¯");

        ws.onclose = () => {
            clearInterval(hb);
            log("sysLog", "âš ï¸ è¿æ¥å…³é—­");

            // âœ… è‡ªåŠ¨é‡è¿
            setTimeout(() => {
                if (retry < 5) {
                    retry++;
                    connectWS();
                }
            }, 1500);
        };
    }

    function closeWS() {
        retry = 99;
        ws?.close();
        clearInterval(hb);
        log("sysLog", "æ‰‹åŠ¨æ–­å¼€");
    }

    function send() {
        ws.send(document.getElementById("sendBox").value);
    }

    function sub() {
        const ch = document.getElementById("sub").value;
        ws.send(JSON.stringify({action: "subscribe", channel: ch}));
        log("sysLog", `è®¢é˜… ${ch}`);
    }

    function unsub() {
        const ch = document.getElementById("sub").value;
        ws.send(JSON.stringify({action: "unsubscribe", channel: ch}));
        log("sysLog", `å–æ¶ˆè®¢é˜… ${ch}`);
    }
</script>

</body>
</html>
